apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: develop-build-docker-image
spec:
  params:
    - name: branch
      description: GitHub branch
      default: develop
  steps:
    - name: fetch-source
      image: alpine/git
      env:
        - name: GITHUB_USERNAME
          valueFrom:
            secretKeyRef:
              name: abdul-github-credentials
              key: username
        - name: GITHUB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: abdul-github-credentials
              key: password
      args:
        - sh
        - -c
        - |
          git clone --single-branch --branch $(params.branch) https://$GITHUB_USERNAME:$GITHUB_PASSWORD@github.com/frankkamando/GasManagementSystemAPI.git /workspace/source
    - name: build
      image: docker:latest
      env:
        - name: GCR_IMAGE_TAG
          value: gcr.io/single-cistern-420705/lpg-mis-api:latest
      command:
        - sh
      args:
        - -c
        - |
          cd /workspace/source
          docker build -t $GCR_IMAGE_TAG .
          docker push $GCR_IMAGE_TAG
